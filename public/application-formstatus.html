<!doctype html>
<html>
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Application Status</title>
<link rel="icon" type="image/jpeg" href="logo.jpeg">
<style>
  body{margin:0;font-family:Segoe UI, Arial;background:#f8f9fa;padding:20px}
  h2{color:#007bff}
  table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
  th,td{border:1px solid #ddd;padding:12px;text-align:center}
  th{background:#007bff;color:#fff}
  tr:nth-child(even){background:#f2f2f2}
  .btn{display:inline-block;padding:10px 16px;background:#007bff;color:#fff;text-decoration:none;border-radius:6px;margin-bottom:20px}
  .btn:hover{background:#0056b3}
  #session-timer-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #f8d7da; /* Light Red/Warning Color */
    color: #721c24; /* Dark Red Text */
    text-align: center;
    padding: 5px 0;
    font-weight: bold;
    z-index: 10000; /* Ensure it is above all other content */
    display: none; /* Initially hidden */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
</style>
</head>
<body>
<div id="session-timer-bar"></div>
  <a href="/student-dashboard" class="btn">Back</a>
  <h2>Application Status</h2>
  <div id="statusBox">Loading...</div>

<script>

  const SESSION_TIMEOUT_MS = 1000 * 60 * 15; // 15 minutes (Must match server.js maxAge)
        const WARNING_TIME_MS = 1000 * 60 * 2;   // Show warning 2 minutes before timeout
        
        let timerInterval;
        let expirationTime = Date.now() + SESSION_TIMEOUT_MS;

        // Simple throttle function (prevents flooding the server with requests)
        function throttle(func, delay) {
            let lastCall = 0;
            return function(...args) {
                const now = Date.now();
                if (now - lastCall > delay) {
                    lastCall = now;
                    func.apply(this, args);
                }
            };
        }

        async function resetSessionActivity() {
            try {
                // Hitting the server to keep the session alive
                const response = await fetch('/keep-alive', { method: 'POST' });

                if (response.ok) {
                    // Update the client-side expiration time
                    expirationTime = Date.now() + SESSION_TIMEOUT_MS;
                    
                    // Restart the timer to reflect the new expiration time
                    startSessionTimer();
                    
                    // Hide the bar if we were in the warning zone
                    document.getElementById('session-timer-bar').style.display = 'none';
                }
            } catch(e) {
                console.error("Keep-alive failed, session may be invalid:", e);
            }
        }
        
        function startSessionTimer() {
            const timerElement = document.getElementById('session-timer-bar');
            if (!timerElement) return;

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const remainingTimeMS = expirationTime - Date.now();
                
                if (remainingTimeMS <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "Session Expired. Redirecting to Login...";
                    // Force client logout and redirect with an error message
                    window.location.href = "/logout?error=" + encodeURIComponent("Your session has expired due to inactivity.");
                    return;
                }

                // Show the timer only when it enters the warning zone
                if (remainingTimeMS <= WARNING_TIME_MS) {
                    const remainingMinutes = Math.floor(remainingTimeMS / (1000 * 60));
                    const remainingSeconds = Math.floor((remainingTimeMS % (1000 * 60)) / 1000);
                    timerElement.style.display = 'block';
                    timerElement.textContent = `⚠️ Session expires in ${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                } else {
                    timerElement.style.display = 'none';
                }

            }, 1000); // Check every second
        }
        
        function setupActivityListeners() {
            ['mousemove', 'keydown', 'scroll', 'touchstart'].forEach(eventType => {
                document.addEventListener(eventType, throttle(resetSessionActivity, 60000)); // Throttle to once per minute
            });
        }

        // Initialize the timer logic
        document.addEventListener('DOMContentLoaded', () => {
            // Start the timer
            startSessionTimer();
            // Setup listeners to reset the timer on activity
            setupActivityListeners();
        });

        // =========================================================
        // === END OF SESSION TIMER SCRIPT ===
        // =========================================================
async function loadStatus(){
  try{
    const res = await fetch('/student/applications', { credentials:'same-origin' });
    const data = await res.json();
    const box = document.getElementById('statusBox');

    if(!data.success){
      box.innerHTML = `<p style="color:red;">${data.message || "Unable to load status"}</p>`;
      return;
    }

    if(data.applications.length === 0){
      box.innerHTML = "<p>No applications found.</p>";
      return;
    }

    let html = "<table><tr><th>Reference No</th><th>Date</th><th>Payment Status</th><th>Approval Status</th></tr>";
    data.applications.forEach(app=>{
      html += `<tr>
        <td>${app.ref_number}</td>
        <td>${new Date(app.application_date).toLocaleDateString()}</td>
        <td>${app.payment_status || "Pending"}</td>
        <td>${app.approval_status || "Pending"}</td>
      </tr>`;
    });
    html += "</table>";
    box.innerHTML = html;

  }catch(err){
    console.error("status error", err);
    document.getElementById('statusBox').innerHTML = "<p style='color:red;'>Server error</p>";
  }
}
document.addEventListener('DOMContentLoaded', loadStatus);
</script>
</body>
</html>
