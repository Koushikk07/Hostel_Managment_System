<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Student Dashboard</title>
    <link rel="icon" type="image/jpeg" href="logo.jpeg" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 0;
      }
      header {
        background: #007bff;
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }
      header h1 {
        margin: 0;
        font-size: 24px;
        flex: 1;
        text-align: center;
      }
      header a {
        position: absolute;
        right: 24px;
        top: 50%;
        transform: translateY(-50%);
        text-decoration: none;
        background: white;
        color: #007bff;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: bold;
        transition: background 0.3s, color 0.3s;
      }
      header a:hover {
        background: #0056b3;
        color: white;
      }
      nav {
        display: flex;
        gap: 12px;
        padding: 16px;
        flex-wrap: wrap;
        justify-content: center;
        background: #e0e0e0;
      }
      nav a,
      .dropdown-btn {
        text-decoration: none;
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border-radius: 6px;
        cursor: pointer;
      }
      nav a:hover,
      .dropdown-btn:hover {
        background: #0056b3;
      }
      .dropdown {
        position: relative;
        display: inline-block;
      }
      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #007bff;
        min-width: 200px;
        border-radius: 6px;
        z-index: 1;
        flex-direction: column;
      }
      .dropdown-content a {
        display: block;
        padding: 12px 16px;
        margin: 2px 0;
      }
      .dropdown:hover .dropdown-content {
        display: flex;
      }

      h2 {
        margin-bottom: 8px;
        color: #007bff;
      }
      .message {
        font-weight: bold;
        margin-top: 8px;
        color: red;
      }
      #session-timer-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #f8d7da; /* Light Red/Warning Color */
    color: #721c24; /* Dark Red Text */
    text-align: center;
    padding: 5px 0;
    font-weight: bold;
    z-index: 10000; /* Ensure it is above all other content */
    display: none; /* Initially hidden */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
    </style>
  </head>
  <body><div id="session-timer-bar"></div>
    <header>
      <h1>Student Dashboard</h1>
      <a href="/logout">Logout</a>
    </header>

    <nav>
      <div class="dropdown">
        <div class="dropdown-btn">Profile &#9662;</div>
        <div class="dropdown-content">
          <a href="profile.html">View Profile</a>
          <a href="forgotpassword.html">Change Password</a>
        </div>
      </div>
      <div class="dropdown">
        <div class="dropdown-btn">Applications &#9662;</div>
        <div class="dropdown-content">
          <a href="hostelform.html">Apply for Hostel</a>
          <a href="application-formstatus.html">Application Status</a>
        </div>
      </div>
      <div class="dropdown">
        <div class="dropdown-btn">Room &#9662;</div>
        <div class="dropdown-content">
          <a href="room-allocation.html">Room Allocation</a>
        </div>
      </div>
      <a href="financial.html">Finance</a>
      <a href="complaints.html">Complaints</a>
      <a href="announcements.html">Announcements</a>
    </nav>

    <main>
      <h2>Welcome, <span id="student-name">Loading...</span></h2>
      <p>Roll No: <span id="student-roll"></span></p>
      <p>Hostel: <span id="student-hostel">Not allocated</span></p>
      <p>Room: <span id="student-room">Not allocated</span></p>
    </main>

    
    <script>
    // =========================================================
    // === SESSION TIMER CONSTANTS & VARIABLES ===
    // =========================================================
    // CRITICAL: Must match the maxAge in server.js (15 * 60 * 1000)
    const SESSION_TIMEOUT_MS = 1000 * 60 * 15; 
    const WARNING_TIME_MS = 1000 * 60 * 2; 
    
    let timerInterval;
    let expirationTime = Date.now() + SESSION_TIMEOUT_MS;
    
    // =========================================================
    // === UTILITY FUNCTIONS (Throttle, Timer Logic) ===
    // =========================================================
    
    function throttle(func, delay) {
        let lastCall = 0;
        return function(...args) {
            const now = Date.now();
            if (now - lastCall > delay) {
                lastCall = now;
                func.apply(this, args);
            }
        };
    }

    async function resetSessionActivity() {
        try {
            // Hitting a server endpoint to keep the session alive (extend expiration time)
            const response = await fetch('/keep-alive', { method: 'POST' });

            if (response.ok) {
                expirationTime = Date.now() + SESSION_TIMEOUT_MS;
                startSessionTimer(); // Restart the timer
                document.getElementById('session-timer-bar').style.display = 'none';
            }
        } catch(e) {
            console.error("Keep-alive failed, session may be invalid:", e);
        }
    }
    
    function startSessionTimer() {
        // ... (Your existing startSessionTimer logic remains the same)
        // Ensure this function is correctly defined below:
        const timerElement = document.getElementById('session-timer-bar');
        if (!timerElement) return;

        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            const remainingTimeMS = expirationTime - Date.now();
            
            if (remainingTimeMS <= 0) {
                clearInterval(timerInterval);
                timerElement.textContent = "Session Expired. Redirecting to Login...";
                // FORCE LOGOUT VIA CLIENT REDIRECT TO SERVER LOGOUT ROUTE
                window.location.href = "/logout?error=" + encodeURIComponent("Your session has expired due to inactivity.");
                return;
            }

            if (remainingTimeMS <= WARNING_TIME_MS) {
                const remainingMinutes = Math.floor(remainingTimeMS / (1000 * 60));
                const remainingSeconds = Math.floor((remainingTimeMS % (1000 * 60)) / 1000);
                timerElement.style.display = 'block';
                timerElement.textContent = `⚠️ Session expires in ${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                timerElement.style.display = 'none';
            }

        }, 1000); 
    }
    
    function setupActivityListeners() {
        ['mousemove', 'keydown', 'scroll', 'touchstart'].forEach(eventType => {
            document.addEventListener(eventType, throttle(resetSessionActivity, 60000));
        });
    }

    // =========================================================
    // === CORE DATA/SESSION CHECK FUNCTION (UNIFIED LOGIC) ===
    // =========================================================

    async function checkSessionAndLoadData() {
        try {
            // CRITICAL: Fetch protected data. If session is dead, server returns non-200.
            const response = await fetch("/api/student/details", {
                credentials: "same-origin",
            });
            
            // 1. HARD SESSION CHECK: If the server returns a non-200 status (e.g., 401/403)
            if (!response.ok) { 
                console.warn("Session expired on server. Redirecting to login.");
                // Redirect to the root URL (which should be the login page)
                window.location.href = "/"; 
                return;
            }
            
            // Session is valid, proceed with data loading
            const data = await response.json();

            if (data.success) {
                // Your existing data loading logic:
                document.getElementById("student-name").textContent = data.name;
                document.getElementById("student-roll").textContent = data.roll;
                
                const hostelElement = document.getElementById("student-hostel");
                const roomElement = document.getElementById("student-room");

                hostelElement.textContent = data.hostel || "Not allocated";
                roomElement.textContent = data.room || "Not allocated";
            } else {
                console.error("Failed to load user data:", data.message);
            }
        } catch (error) {
            console.error("Network or server error:", error);
            // In case of network error, also force a redirect as the session is unreliable
            window.location.href = "/"; 
        }
    }


    // =========================================================
    // === INITIALIZATION AND BACK-BUTTON FIX ===
    // =========================================================

    document.addEventListener("DOMContentLoaded", () => {
        // Start the data load/session check
        checkSessionAndLoadData();
        
        // Start the client-side timer
        startSessionTimer(); 
        setupActivityListeners();
    });

    // CRITICAL FIX: The Back-Button Killer
    window.addEventListener("pageshow", function (event) {
        // If the page was restored from the browser cache (back button was hit)
        if (event.persisted) {
            console.log("Page restored from cache. Forcing server session re-check.");
            // Call the same function that checks the session status against the server.
            checkSessionAndLoadData();
            
            // Also reset the client-side timer, as bfcache restores old state
            expirationTime = Date.now() + SESSION_TIMEOUT_MS;
            startSessionTimer();
        }
    });

</script>
  </body>
</html>
