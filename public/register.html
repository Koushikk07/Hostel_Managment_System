<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Registration</title>
  <link rel="icon" type="image/jpeg" href="logo.jpeg">
  <style>
    body {background:linear-gradient(135deg,#6a11cb,#2575fc);min-height:100vh;display:flex;justify-content:center;align-items:center;}
    .container {background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.2);max-width:500px;width:100%;overflow:hidden;}
    .header {background:#4a6fc7;color:#fff;padding:20px;text-align:center;}
    .form-container {padding:30px;}
    .form-group{margin-bottom:15px;}
    label{display:block;margin-bottom:6px;font-weight:600;}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;}
    .error{color:red;font-size:13px;display:none;}
    button{background:#4a6fc7;color:white;border:none;padding:12px;width:100%;border-radius:5px;font-weight:bold;cursor:pointer;}
    button:hover{background:#3b5aa6;}
    .login-link{text-align:center;margin-top:10px;}
    #session-timer-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #f8d7da; /* Light Red/Warning Color */
    color: #721c24; /* Dark Red Text */
    text-align: center;
    padding: 5px 0;
    font-weight: bold;
    z-index: 10000; /* Ensure it is above all other content */
    display: none; /* Initially hidden */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
  </style>
</head>
<body>
  <div id="session-timer-bar"></div>
  <div class="container">
    <div class="header"><h2>User Registration</h2></div>
    <div class="form-container">
      <form id="registerForm">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" name="full_name" required>
        </div>
        <div class="form-group">
          <label>Roll Number</label>
          <input type="text" name="roll_no" pattern="^[0-9]+$" title="Only numbers allowed" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" name="phone" pattern="^[0-9]{10}$" title="Enter 10 digit number" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" name="password" required>
          <small>Password must be ≥8 chars and include uppercase, lowercase, number & symbol</small>
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="confirmPassword" required>
          <div class="error" id="confirmError">Passwords do not match</div>
        </div>
        <button type="submit">Register</button>
      </form>
      <div class="login-link">Already registered? <a href="login.html">Login</a></div>
    </div>
  </div>

  <script>

    const SESSION_TIMEOUT_MS = 1000 * 60 * 15; // 15 minutes (Must match server.js maxAge)
        const WARNING_TIME_MS = 1000 * 60 * 2;   // Show warning 2 minutes before timeout
        
        let timerInterval;
        let expirationTime = Date.now() + SESSION_TIMEOUT_MS;

        // Simple throttle function (prevents flooding the server with requests)
        function throttle(func, delay) {
            let lastCall = 0;
            return function(...args) {
                const now = Date.now();
                if (now - lastCall > delay) {
                    lastCall = now;
                    func.apply(this, args);
                }
            };
        }

        async function resetSessionActivity() {
            try {
                // Hitting the server to keep the session alive
                const response = await fetch('/keep-alive', { method: 'POST' });

                if (response.ok) {
                    // Update the client-side expiration time
                    expirationTime = Date.now() + SESSION_TIMEOUT_MS;
                    
                    // Restart the timer to reflect the new expiration time
                    startSessionTimer();
                    
                    // Hide the bar if we were in the warning zone
                    document.getElementById('session-timer-bar').style.display = 'none';
                }
            } catch(e) {
                console.error("Keep-alive failed, session may be invalid:", e);
            }
        }
        
        function startSessionTimer() {
            const timerElement = document.getElementById('session-timer-bar');
            if (!timerElement) return;

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const remainingTimeMS = expirationTime - Date.now();
                
                if (remainingTimeMS <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "Session Expired. Redirecting to Login...";
                    // Force client logout and redirect with an error message
                    window.location.href = "/logout?error=" + encodeURIComponent("Your session has expired due to inactivity.");
                    return;
                }

                // Show the timer only when it enters the warning zone
                if (remainingTimeMS <= WARNING_TIME_MS) {
                    const remainingMinutes = Math.floor(remainingTimeMS / (1000 * 60));
                    const remainingSeconds = Math.floor((remainingTimeMS % (1000 * 60)) / 1000);
                    timerElement.style.display = 'block';
                    timerElement.textContent = `⚠️ Session expires in ${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                } else {
                    timerElement.style.display = 'none';
                }

            }, 1000); // Check every second
        }
        
        function setupActivityListeners() {
            ['mousemove', 'keydown', 'scroll', 'touchstart'].forEach(eventType => {
                document.addEventListener(eventType, throttle(resetSessionActivity, 60000)); // Throttle to once per minute
            });
        }

        // Initialize the timer logic
        document.addEventListener('DOMContentLoaded', () => {
            // Start the timer
            startSessionTimer();
            // Setup listeners to reset the timer on activity
            setupActivityListeners();
        });

        // =========================================================
        // === END OF SESSION TIMER SCRIPT ===
        // ========================================================
    document.getElementById("registerForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const pass = document.getElementById("password").value;
      const confirm = document.getElementById("confirmPassword").value;

      // Password pattern
      const passPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
      if (!passPattern.test(pass)) {
        alert("Password must be ≥8 chars, include uppercase, lowercase, number & special char.");
        return;
      }
      if (pass !== confirm) {
        document.getElementById("confirmError").style.display = "block";
        return;
      } else {
        document.getElementById("confirmError").style.display = "none";
      }

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      try {
        const res = await fetch("/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          alert("Registration successful!");
          window.location.href = "/"; // redirect to login
        } else {
          alert(result.message || "Registration failed");
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
</html>
